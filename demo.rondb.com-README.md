# demo.rondb.com

## Hosts

The cluster runs on 3 dedicated Hetzner machines:

* `rondbdemo0.hops.works` (or `rondbdemo0.devnet.hops.works`)
* `rondbdemo1.hops.works` (or `rondbdemo1.devnet.hops.works`)
* `rondbdemo2.hops.works` (or `rondbdemo2.devnet.hops.works`)

## Secrets

You need the following files in this directory to operate the cluster:
* `id_rondbdemo`
* `id_rondbdemo.pub`
* `secrets.json`

You can download them from `thesofa:/demo.rondb.com-secrets/`.

Note that `secrets.json` is generated by `./cluster_ctl` unless it exists, but you need to download it to make it work with the existing cluster.

## Setup

The rondbdemo*.hops.works hosts are set up like this:

* Hostname set in `/etc/hosts` and `/etc/hostname`.
* Joined to devnet VPN, each as routers for a `/24` subnet that is used for the VMs.
  This means that the VMs don't need wireguard installed, but are still accessible over devnet VPN.
* Software and networking setup (details hard-coded in `./demo.rondb.com-ctl`):
  ./demo.rondb.com-ctl setup_hosts
* VMs created with pinned CPUs and designated memory/disk resources (details hard-coded in `./demo.rondb.com-ctl`):
  ./demo.rondb.com-ctl setup_vms

## Operation

* `./demo.rondb.com-ctl ssh_config`
    Print ssh config for connecting to hosts and VMs.
    Add this to your `~/.ssh/config` if you want to be able to access the nodes like `ssh ndbmtd-1.rondbdemo`.
    This can be convenient for file uploads etc. but not necessary.
    You can still use `./cluster_ctl ssh ndbmtd-1` even without this config.

* `./demo.rondb.com-ctl setup_hosts`
    Setup dedicated hosts.
    Initially, run this twice, separated by a restart.
    Not all things are persisted, so after each restart, run setup_hosts again.

* `./demo.rondb.com-ctl restart_hosts`
    Restart all hosts.

* `./demo.rondb.com-ctl setup_vms`
    Setup or reprovision VMs on dedicated hosts.

* `./demo.rondb.com-ctl destroy_vms`
    Destroy all VMs. This means IRREVOCABLE data loss.

* `./demo.rondb.com-ctl cluster_config`
    Print a config that gives `./cluster_ctl` access to the cluster. Add it to the end of `./config.py`.

* `./cluster_ctl start_demo`
    Start the demo.rondb.com web UI server that allows anonymous users to create databases, run benchmarks and monitor.
    The UI runs on the first bench node, but will not be started with `./cluster_ctl start`.
    Also, note that you need to do `./cluster_ctl deploy` first.

* `./cluster_ctl stop_demo`
    Stop the demo.rondb.com web UI server.

## **WARNING:** Gotchas / foot guns

* Both `./cluster_ctl stop` and `./cluster_ctl start` will *stop* all processes, including the web UI server and all locust processes, even those run by anonymous users.
  You will need to start the web UI server manually with `./cluster_ctl start_demo`.
* Do not use the `./cluster_ctl` sub-commands `bench_locust`, `populate`, `start_locust` and `stop_locust`.
  These can interfere in weird ways with the locust processes started by anonymous users.
* If you use the admin GUI secret, e.g. to access grafana, then you won't be able to access locust from the web UI.
  Use a separate browser session in such case.

## Monitoring

* To download the current monitoring information, run
  ```
  ./cluster_ctl ssh bench cat durable/demo_state.json > demo_state.json
  ./cluster_ctl ssh bench cat durable/demo.log > demo.log
  cp demo.log "demo.log.$(date +%Y%m%d%H%M%S)"
  ```
  This will also make a backup of `demo.log`, which is a good idea to do regularly even though it's not supposed to be overwritten on restart.
* You can then analyze these files in various ways, for example
  * Run
    ```
    < demo.log jq 'select(.msg=="Accessed /try")'
    ```
    to list the instances of clicking on email links.
    Here you'll see the `session` (client device) connected to a `key`.
    The `key` is a Hubspot ID, and you can search for it in Hubspot to get contact information.
  * Run
    ```
    < demo.log jq 'select(.session=="fceba667c8043d498b99")'
    ```
    to see the events for a particular client device.
  * Run
    ```
    < demo_state.json jq '.user_sessions|to_entries[]|({session:.key}+.value)|select(.db!=null)'
    ```
    to see sessions with a database.
  * Run
    ```
    < demo.log jq 'select(.type!="info")'
    ```
    to all errors.
